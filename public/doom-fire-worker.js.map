{"version":3,"file":"doom-fire-worker.js","sources":["../src/doom-fire-animation.mjs","../src/doom-fire-worker.js"],"sourcesContent":["const HTML_COLOR_SCALE = [\n  parseColor(0x070707), parseColor(0x1f0707), parseColor(0x2f0f07),\n  parseColor(0x470f07), parseColor(0x571707), parseColor(0x671f07),\n  parseColor(0x771f07), parseColor(0x8f2707), parseColor(0x9f2f07),\n  parseColor(0xaf3f07), parseColor(0xbf4707), parseColor(0xc74707),\n  parseColor(0xDF4F07), parseColor(0xDF5707), parseColor(0xDF5707),\n  parseColor(0xD75F07), parseColor(0xD7670F), parseColor(0xcf6f0f),\n  parseColor(0xcf770f), parseColor(0xcf7f0f), parseColor(0xCF8717),\n  parseColor(0xC78717), parseColor(0xC78F17), parseColor(0xC7971F),\n  parseColor(0xBF9F1F), parseColor(0xBF9F1F), parseColor(0xBFA727),\n  parseColor(0xBFA727), parseColor(0xBFAF2F), parseColor(0xB7AF2F),\n  parseColor(0xB7B72F), parseColor(0xB7B737), parseColor(0xCFCF6F),\n  parseColor(0xDFDF9F), parseColor(0xEFEFC7), parseColor(0xFFFFFF)   \n];\nconst BLE = 1000 / 27; // DoomFire runs at 27FPS.\nexport default class DoomFireAnimation {\n  constructor(ctx) {\n    this.flames = [];\n    this.width = 320;\n    this.height = 200;\n    this.ctx = ctx;\n    this.imageData = this.ctx.getImageData(0, 0, this.width, this.height);    \n    this._init();\n    this.lastUpdate = 0;\n    this.active = true;\n  }\n\n  posAt(x, y) {\n    return y * this.width + x;\n  }\n    \n  setValue(x, y, value) {\n    let pos = this.posAt(x, y);\n    this.flames[pos] = value; \n  }\n\n  valueAt(x, y) {\n    let pos = this.posAt(x, y);\n    return this.flames[pos];\n  }  \n\n  _init() {\n    this._initCanvas();\n    this._initFlames();\n  }\n\n  _initFlames() {\n    // Initialise the flames.\n    for (let x = 0; x < this.width; x++) {\n      for (let y = 1; y < this.height; y++) {\n        this.setValue(x, y, 0);\n      }\n    }\n\n    for (let x = 0; x < this.width; x++) {\n      this.setValue(x, 0, 35);      \n    }\n  }\n  _initCanvas() {\n    // Initialise the canvas with black.\n    for (let i = 0; i < this.imageData.data.length; i++) {\n      this.imageData.data[i] = 0;\n      if (i % 4 == 3) this.imageData.data[i] = 255;\n    }\n  }\n\n  update() {\n    let now = performance.now();\n    if (now - this.lastUpdate < BLE) {\n      return;\n    }\n\n    performance.mark('start');\n    for (let srcY = 0; srcY < this.height; srcY++) {\n      const srcRow = srcY * this.width;\n      const dstRow = (srcY + 1) * this.width;\n      const imageRow = (this.height - srcY) * this.width;\n      for (let srcX = 0; srcX < this.width; srcX++) {      \n        const rand = Math.round(Math.random() * 3.0) & 3;\n  \n        const srcIndex = srcRow + srcX;\n        const srcColor = this.flames[srcIndex];\n        const dstColor = srcColor - (rand & 1);\n  \n        const dstX = srcX + rand - 1;\n          \n        const index = dstRow + dstX;\n        this.flames[index] = dstColor; \n  \n        const pos = (imageRow + srcX) * 4;  \n        if (srcColor > 0) {\n          const color = HTML_COLOR_SCALE[srcColor];\n          this.imageData.data[pos] = color.r;\n          this.imageData.data[pos + 1] = color.g;\n          this.imageData.data[pos + 2] = color.b;\n          this.imageData.data[pos + 3] = 255;\n        } else {\n          this.imageData.data[pos] = 0;\n          this.imageData.data[pos + 1] = 0;\n          this.imageData.data[pos + 2] = 0;\n          this.imageData.data[pos + 3] = 255;        \n        }\n      }\n    }\n    this.ctx.putImageData(this.imageData, 0, 0);  \n    this.lastUpdate = now;\n    performance.mark('end');\n    performance.measure('elapsed', 'start', 'end');\n  }\n\n  toggle() {\n    if (this.active) {\n      for (let x = 0; x < this.width; x++) {\n        this.setValue(x, 0, 0);      \n      }    \n    } else {\n      for (let x = 0; x < this.width; x++) {\n        this.setValue(x, 0, 35);      \n      }    \n    }\n    this.active = !this.active;    \n  }  \n}\n\nfunction parseColor(color) {\n  const b = color & 0xFF;\n  const g = color >> 8 & 0xFF;\n  const r = color >> 16 & 0xFF;\n  return {r, g, b}\n}\n","import DoomFireAnimation from './doom-fire-animation.mjs';\n\nlet canvas;\nlet doomFireAnimation;\n\nfunction update() {\n  doomFireAnimation.update();\n  self.requestAnimationFrame(update);\n}\n\nself.onmessage = function(ev) {\n  if(ev.data.msg === 'init') {\n    canvas = ev.data.canvas;\n    let ctx = canvas.getContext('2d');\n    doomFireAnimation = new DoomFireAnimation(ctx);\n  }\n\n  if (ev.data.msg === 'start') {\n    update();\n  }\n\n  if (ev.data.msg === 'toggle') {\n    doomFireAnimation.toggle();\n  }  \n}\n"],"names":[],"mappings":"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"}