{"version":3,"file":"bundle.js","sources":["../src/doom-fire-animation.mjs","../src/doom-fire.mjs","../src/wake-lock.mjs","../src/fullscreen.mjs","../src/service-worker.mjs"],"sourcesContent":["const HTML_COLOR_SCALE = [\n  parseColor(0x070707), parseColor(0x1f0707), parseColor(0x2f0f07),\n  parseColor(0x470f07), parseColor(0x571707), parseColor(0x671f07),\n  parseColor(0x771f07), parseColor(0x8f2707), parseColor(0x9f2f07),\n  parseColor(0xaf3f07), parseColor(0xbf4707), parseColor(0xc74707),\n  parseColor(0xDF4F07), parseColor(0xDF5707), parseColor(0xDF5707),\n  parseColor(0xD75F07), parseColor(0xD7670F), parseColor(0xcf6f0f),\n  parseColor(0xcf770f), parseColor(0xcf7f0f), parseColor(0xCF8717),\n  parseColor(0xC78717), parseColor(0xC78F17), parseColor(0xC7971F),\n  parseColor(0xBF9F1F), parseColor(0xBF9F1F), parseColor(0xBFA727),\n  parseColor(0xBFA727), parseColor(0xBFAF2F), parseColor(0xB7AF2F),\n  parseColor(0xB7B72F), parseColor(0xB7B737), parseColor(0xCFCF6F),\n  parseColor(0xDFDF9F), parseColor(0xEFEFC7), parseColor(0xFFFFFF)   \n];\nconst BLE = 1000 / 27; // DoomFire runs at 27FPS.\nexport default class DoomFireAnimation {\n  constructor(ctx) {\n    this.flames = [];\n    this.width = 320;\n    this.height = 200;\n    this.ctx = ctx;\n    this.imageData = this.ctx.getImageData(0, 0, this.width, this.height);    \n    this._init();\n    this.lastUpdate = 0;\n    this.active = true;\n  }\n\n  posAt(x, y) {\n    return y * this.width + x;\n  }\n    \n  setValue(x, y, value) {\n    let pos = this.posAt(x, y);\n    this.flames[pos] = value; \n  }\n\n  valueAt(x, y) {\n    let pos = this.posAt(x, y);\n    return this.flames[pos];\n  }  \n\n  _init() {\n    this._initCanvas();\n    this._initFlames();\n  }\n\n  _initFlames() {\n    // Initialise the flames.\n    for (let x = 0; x < this.width; x++) {\n      for (let y = 1; y < this.height; y++) {\n        this.setValue(x, y, 0);\n      }\n    }\n\n    for (let x = 0; x < this.width; x++) {\n      this.setValue(x, 0, 35);      \n    }\n  }\n  _initCanvas() {\n    // Initialise the canvas with black.\n    for (let i = 0; i < this.imageData.data.length; i++) {\n      this.imageData.data[i] = 0;\n      if (i % 4 == 3) this.imageData.data[i] = 255;\n    }\n  }\n\n  update() {\n    let now = performance.now();\n    if (now - this.lastUpdate < BLE) {\n      return;\n    }\n\n    performance.mark('start');\n    for (let srcY = 0; srcY < this.height; srcY++) {\n      const srcRow = srcY * this.width;\n      const dstRow = (srcY + 1) * this.width;\n      const imageRow = (this.height - srcY) * this.width;\n      for (let srcX = 0; srcX < this.width; srcX++) {      \n        const rand = Math.round(Math.random() * 3.0) & 3;\n  \n        const srcIndex = srcRow + srcX;\n        const srcColor = this.flames[srcIndex];\n        const dstColor = srcColor - (rand & 1);\n  \n        const dstX = srcX + rand - 1;\n          \n        const index = dstRow + dstX;\n        this.flames[index] = dstColor; \n  \n        const pos = (imageRow + srcX) * 4;  \n        if (srcColor > 0) {\n          const color = HTML_COLOR_SCALE[srcColor];\n          this.imageData.data[pos] = color.r;\n          this.imageData.data[pos + 1] = color.g;\n          this.imageData.data[pos + 2] = color.b;\n          this.imageData.data[pos + 3] = 255;\n        } else {\n          this.imageData.data[pos] = 0;\n          this.imageData.data[pos + 1] = 0;\n          this.imageData.data[pos + 2] = 0;\n          this.imageData.data[pos + 3] = 255;        \n        }\n      }\n    }\n    this.ctx.putImageData(this.imageData, 0, 0);  \n    this.lastUpdate = now;\n    performance.mark('end');\n    performance.measure('elapsed', 'start', 'end');\n  }\n\n  toggle() {\n    if (this.active) {\n      for (let x = 0; x < this.width; x++) {\n        this.setValue(x, 0, 0);      \n      }    \n    } else {\n      for (let x = 0; x < this.width; x++) {\n        this.setValue(x, 0, 35);      \n      }    \n    }\n    this.active = !this.active;    \n  }  \n}\n\nfunction parseColor(color) {\n  const b = color & 0xFF;\n  const g = color >> 8 & 0xFF;\n  const r = color >> 16 & 0xFF;\n  return {r, g, b}\n}\n","\nimport DoomFireAnimation from './doom-fire-animation.mjs';\n\nexport default class DoomFire extends HTMLElement {\n  constructor() {\n    super();\n    this.active = true;\n\n    // Create a Canvas to draw the flames.\n    this.canvas = document.createElement('canvas');\n    this.offscreen = typeof(this.canvas.transferControlToOffscreen) != 'undefined';\n\n    // Set size.\n    this.canvas.width = 320;\n    this.canvas.height = 200;\n\n    // Make it fill the whole element.\n    this.canvas.style.width = '100%';\n    this.canvas.style.height = '100%';\n\n    if (this.offscreen) {\n      console.log('Rendering with Offscreen Canvas.');\n      const offscreenCanvas = this.canvas.transferControlToOffscreen();\n      offscreenCanvas.width = 320;\n      offscreenCanvas.height = 200;      \n      this.worker = new Worker('doom-fire-worker.js');\n      this.worker.postMessage({msg: 'init', canvas: offscreenCanvas}, [offscreenCanvas]);\n    } else {\n      console.log('Rendering with regular Canvas.');\n      let ctx = this.canvas.getContext('2d');\n      this.animation = new DoomFireAnimation(ctx);\n    }\n\n    const shadowRoot = this.attachShadow({mode: 'open'});\n    shadowRoot.appendChild(this.canvas);\n     \n    this.addEventListener('click', () => {\n      this.toggle();\n    });\n  }\n\n  connectedCallback() {\n    if (this.offscreen) {\n      this.worker.postMessage({msg: 'start'});\n    } else {\n      this.update();\n    }\n  }  \n\n  toggle() {\n    if (this.offscreen) {\n      this.worker.postMessage({msg: 'toggle'});      \n    } else {\n      this.animation.toggle();\n    }    \n  }\n\n  update() {\n    this.animation.update();\n    window.requestAnimationFrame(this.update.bind(this));\n  }\n}\n\nif (!customElements.get('doom-fire')) {\n  customElements.define('doom-fire', DoomFire);\n}\n","const keepAwakeButton = document.querySelector('#keep-awake');\nlet wakeLock;\nif ('wakeLock' in navigator) {\n  console.log('Wake Lock API supported ðŸŽ‰')\n  keepAwakeButton.removeAttribute('disabled');\n  keepAwakeButton.classList.remove('hidden');\n}\n\nconst requestWakeLock = async () => {\n  try {\n    wakeLock = await navigator.wakeLock.request('screen');\n    wakeLock.addEventListener('release', () => {\n      keepAwakeButton.checked = false;\n      console.log('Screen Wake Lock was released.');\n    }, {once: true});\n    console.log('Screen Wake Lock is active.');\n    keepAwakeButton.checked = true;\n  } catch(err) {\n    console.error(`${err.name}, ${err.message}`);\n  }\n};\n\nconst releaseWakeLock = async() => {\n  try {\n    wakeLock.release();\n    wakeLock = null;\n  } catch(err) {\n    console.error(`${err.name}, ${err.message}`);\n  }\n};\n\nkeepAwakeButton.addEventListener('click', async () => {\n  if (wakeLock) {\n    await releaseWakeLock();\n  } else {\n    await requestWakeLock();\n  }\n});\n\nconst handleVisibilityChange = () => {\n  if (wakeLock !== null && document.visibilityState === 'visible') {\n    requestWakeLock();\n  }\n};\n\ndocument.addEventListener('visibilitychange', handleVisibilityChange);\n","const fullscreenButton = document.querySelector('#fullscreen');\n\nfullscreenButton.addEventListener('click', async () => {\n  try {\n    if (document.fullscreenElement) {\n      console.log('Exiting fullscreen.');\n      await document.exitFullscreen();\n    } else {\n      console.log('Entering fullscreen.');\n      await document.body.requestFullscreen();\n    }\n  } catch (err) {\n    console.error(`${err.name}, ${err.message}`);    \n  }\n});\n\ndocument.body.addEventListener('fullscreenchange', (e) => {\n  if (document.fullscreenElement) {\n    fullscreenButton.checked = true;\n  } else {\n    fullscreenButton.checked = false;\n  }\n});\n","if ('serviceWorker' in navigator) {\n  // Use the window load event to keep the page load performant\n  window.addEventListener('load', () => {\n    navigator.serviceWorker.register('/sw.js');\n  });\n}"],"names":["HTML_COLOR_SCALE","parseColor","BLE","DoomFireAnimation","[object Object]","ctx","this","flames","width","height","imageData","getImageData","_init","lastUpdate","active","x","y","value","pos","posAt","_initCanvas","_initFlames","setValue","i","data","length","now","performance","mark","srcY","srcRow","dstRow","imageRow","srcX","rand","Math","round","random","srcIndex","srcColor","dstColor","index","color","r","g","b","putImageData","measure","DoomFire","HTMLElement","super","canvas","document","createElement","offscreen","style","console","log","offscreenCanvas","transferControlToOffscreen","worker","Worker","postMessage","msg","getContext","animation","attachShadow","mode","appendChild","addEventListener","toggle","update","window","requestAnimationFrame","bind","customElements","get","define","keepAwakeButton","querySelector","wakeLock","navigator","removeAttribute","classList","remove","requestWakeLock","async","request","checked","once","err","error","name","message","release","releaseWakeLock","visibilityState","fullscreenButton","fullscreenElement","exitFullscreen","body","requestFullscreen","e","serviceWorker","register"],"mappings":"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"}